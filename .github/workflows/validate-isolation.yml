name: Validate Package Isolation

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  validate-isolation:
    name: Validate Package Isolation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check for monorepo imports
        run: |
          echo "üîç Scanning for monorepo imports..."
          
          # Check for @/domains imports (excluding comments)
          DOMAIN_IMPORTS=$(grep -r "from ['\"]@/domains" src tests examples --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "//" | grep -v "^\s*\*" || true)
          if [ -n "$DOMAIN_IMPORTS" ]; then
            echo "‚ùå Monorepo domain imports detected:"
            echo "$DOMAIN_IMPORTS"
            exit 1
          fi
          
          # Check for @/infrastructure imports (excluding zkim-file-format)
          INFRA_IMPORTS=$(grep -r "from ['\"]@/infrastructure" src tests examples --include="*.ts" --include="*.tsx" 2>/dev/null | grep -v "zkim-file-format" | grep -v "//" | grep -v "^\s*\*" || true)
          if [ -n "$INFRA_IMPORTS" ]; then
            echo "‚ùå Monorepo infrastructure imports detected:"
            echo "$INFRA_IMPORTS"
            exit 1
          fi
          
          # Check for parent directory references
          PARENT_REFS=$(grep -r "from ['\"]\.\./\.\./\.\." src tests examples --include="*.ts" --include="*.tsx" 2>/dev/null || true)
          if [ -n "$PARENT_REFS" ]; then
            echo "‚ùå Parent directory references detected:"
            echo "$PARENT_REFS"
            exit 1
          fi
          
          echo "‚úÖ No monorepo imports detected"
          echo "‚úÖ Package isolation validated"
      
      - name: Validate file scope
        run: |
          echo "üîç Validating file scope..."
          
          # Check if any files reference monorepo structure
          MONOREPO_FILES=$(find . -type f -name "*.ts" -o -name "*.tsx" -o -name "*.json" | xargs grep -l "workspaces\|packages/" 2>/dev/null | grep -v node_modules | grep -v ".git" || true)
          
          # Filter out package.json (it's allowed to reference packages for dependencies)
          MONOREPO_FILES=$(echo "$MONOREPO_FILES" | grep -v "package.json" || true)
          
          if [ -n "$MONOREPO_FILES" ]; then
            echo "‚ö†Ô∏è  Files with potential monorepo references:"
            echo "$MONOREPO_FILES"
            echo "   (This may be a false positive - review manually)"
          fi
          
          echo "‚úÖ File scope validation complete"
